<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title><%= book.title %> by <%= book.author %></title>
    <link rel="stylesheet" href="/styles/main.css" />
    <link rel="stylesheet" href="/styles/footer.css" />
    <link rel="stylesheet" href="/styles/search-filter.css" />
    <link rel="icon" href="/images/vxnhe-icon.png" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script defer src="/js/homepage.js"></script>
</head>

<body>
    <header>
        <%- include('../partials_readers/head_navigation.ejs') %>
    </header>

    <main>
        <div class="container">
            <div class="book-cover">
                <!-- TODO: Add carousel for multiple cover images -->
                <% if (book.coverImages && book.coverImages.length > 0) { %>
                <img src="<%= book.coverImages[0] %>" alt="<%= book.title %> Cover">
                <% } else { %>
                <img src="/images/default-book-cover.jpg" alt="Default Cover Image">
                <% } %>
            </div>

            <div class="book-detail">
                <h1 id="book-title"><%= book.title %></h1>
                <h2 id="author"><%= book.author %></h2>

                <div class="book-info">
                    <p class="category">Category: <%= book.category %></p>
                    <p class="publish-date">Publish Date: <%= book.publishDate.toLocaleDateString() %></p>
                    <% if (book.description) { %>
                    <p class="description">Description: <%= book.description %></p>
                    <% } %>
                    <p class="quantity">Quantity: <%= book.amount %></p>

                </div>
                <% if (user && user.__t === "Reader") { %>
                <!-- Reader-specific content -->
                <div class="reader-buttons">
                    <div class="cart-btn">
                        <form class="form" action="/reader/add-cart/<%= book._id %>" method="POST">
                            <button type="submit">Add to Cart</button>
                        </form>
                    </div>

                    <div class="wishlist-btn">
                        <form class="form" action="/reader/add-wishlist/<%= book._id %>" method="POST">
                            <button type="submit">Add to Wishlist</button>
                        </form>
                    </div>
                </div>

                <% } else if (user && user.__t === "Librarian") { %>
                <!-- Librarian-specific content -->
                <div class="librarian-buttons">
                    <div class="edit-btn">
                        <form class="form" action="/librarian/book_detail/<%= book._id %>" method="POST">
                            <button type="submit">Edit book</button>
                        </form>
                    </div>

                    <div class="delete-btn">
                        <form class="form" action="/librarian/delete_book/<%= book._id %>" method="POST">
                            <button type="submit">Delete book</button>
                        </form>
                    </div>
                    <% } else { %>
                    <!-- Default content for other roles or unauthenticated users -->
                    <% } %>
                </div>
            </div>
    </main>

    <%- include('../partials_readers/footer.ejs') %>

    <script>
    // Function to handle form submission
    async function handleFormSubmission(form) {
        try {
        const response = await fetch(form.action, {
            method: form.method,
            body: new FormData(form),
            headers: {
            'Accept': 'application/json',
            },
        });

        if (response.ok) {
            // Redirect to the current page
            window.location.reload(true);
        } else {
            const errorData = await response.json();
            alert(errorData.errors);
        }
        } catch (error) {
        console.error('Error:', error);
        }
    }

    // Attach event listener to each form with class "form"
    const wishlistForms = document.querySelectorAll('.form');
    wishlistForms.forEach(form => {
        form.addEventListener('submit', function (event) {
        event.preventDefault();
        handleFormSubmission(this);
        });
    });
    </script>
</body>

</html>
